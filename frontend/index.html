<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="color-scheme" content="light dark">
    <title>–ò–∑–±—Ä–∞–Ω–Ω–æ–µ Pro</title>
    <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
    <style>
        :root {
            --primary-color: #0d6efd; --background-light: #f8f9fa; --background-dark: #121212;
            --card-background-light: #ffffff; --card-background-dark: #1e1e1e; --text-light: #212529;
            --text-dark: #e3e3e3; --border-light: #dee2e6; --border-dark: #444;
        }
        @media (prefers-color-scheme: light) {
            body { background-color: var(--background-light); color: var(--text-light); }
            .card, .modal-content { background: var(--card-background-light); }
            input[type="text"] { border-color: var(--border-light); background-color: #fff; color: var(--text-light); }
            .board-btn { background-color: #e9ecef; color: var(--text-light); }
            .item-card { border-color: var(--border-light); }
            .loader { border-top-color: #3498db; }
        }
        @media (prefers-color-scheme: dark) {
            body { background-color: var(--background-dark); color: var(--text-dark); }
            .card, .modal-content { background: var(--card-background-dark); }
            input[type="text"] { border-color: var(--border-dark); background-color: #333; color: var(--text-dark); }
            .board-btn { background-color: #343a40; color: var(--text-dark); border: 1px solid var(--border-dark); }
            .board-btn:hover { background-color: #495057; }
            .item-card { border-color: var(--border-dark); }
            .loader { border-top-color: #3498db; }
        }
        [v-cloak] { display: none; }
        body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Helvetica, Arial, sans-serif; margin: 0; display: flex; justify-content: center; transition: background-color 0.3s, color 0.3s; }
        .app-container { width: 100%; max-width: 900px; padding: 20px; }
        .card { border-radius: 8px; box-shadow: 0 4px 12px rgba(0,0,0,0.1); padding: 24px; margin-bottom: 20px; }
        h1, h2 { text-align: center; }
        input[type="text"] { width: calc(100% - 24px); padding: 12px; border: 1px solid; border-radius: 6px; font-size: 16px; margin-bottom: 10px; }
        button { display: block; width: 100%; padding: 12px; font-size: 16px; font-weight: bold; color: #fff; background-color: var(--primary-color); border: none; border-radius: 6px; cursor: pointer; transition: background-color 0.2s; }
        button:hover:not(:disabled) { opacity: 0.9; }
        button:disabled { background-color: #6c757d; cursor: not-allowed; }
        .help-text { font-size: 14px; color: #6c757d; text-align: center; margin-top: 10px; }
        .help-text a { color: var(--primary-color); text-decoration: none; font-weight: 500; }
        .converter-toggle { color: var(--primary-color); cursor: pointer; text-align: center; margin-top: 15px; }
        .loader-container { padding: 40px; display: flex; justify-content: center; align-items: center; }
        .loader { border: 4px solid #f3f3f3; border-radius: 50%; border-top: 4px solid var(--primary-color); width: 40px; height: 40px; animation: spin 1s linear infinite; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        #boards-list { display: flex; flex-wrap: wrap; gap: 10px; justify-content: center; padding: 0;}
        .board-btn { width: auto; flex-grow: 1; }
        #items-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(250px, 1fr)); gap: 20px; margin-top: 20px; }
        .item-card { border: 1px solid; border-radius: 8px; padding: 15px; cursor: pointer; box-shadow: 0 1px 2px rgba(0,0,0,0.1); transition: box-shadow 0.2s, transform 0.2s; }
        .item-card:hover { box-shadow: 0 4px 8px rgba(0,0,0,0.15); transform: translateY(-2px); }
        .item-card p { margin: 0; font-weight: 500; word-wrap: break-word; }
        .back-btn { margin-top: 20px; background-color: #6c757d; }
        .modal-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0, 0, 0, 0.7); display: flex; justify-content: center; align-items: center; z-index: 1000; }
        .modal-content { padding: 20px; border-radius: 8px; max-width: 90%; max-height: 90%; overflow-y: auto; text-align: center; min-width: 300px; }
        .modal-content a.open-link { display: inline-block; padding: 12px 24px; background-color: var(--primary-color); color: #fff; text-decoration: none; border-radius: 6px; font-weight: bold; margin-top: 20px; }
    </style>
</head>
<body>
    <div id="app" v-cloak>
        <main class="app-container">
            <section v-if="currentView === 'login'" class="card">
                <div v-if="showConverter">
                    <h1>–ö–æ–Ω–≤–µ—Ä—Ç–µ—Ä Username –≤ ID</h1>
                    <input type="text" v-model="usernameToResolve" @keyup.enter="resolveUsername" placeholder="–í–≤–µ–¥–∏—Ç–µ username –±–µ–∑ @">
                    <button @click="resolveUsername" :disabled="isLoading.resolving">
                        <span v-if="!isLoading.resolving">–ü–æ–ª—É—á–∏—Ç—å ID</span>
                        <span v-else>–ü–æ–∏—Å–∫...</span>
                    </button>
                    <div v-if="resolvedId" class="help-text" style="color: green; font-weight: bold;">
                        –ù–∞–π–¥–µ–Ω ID: {{ resolvedId }} (—Å–∫–æ–ø–∏—Ä–æ–≤–∞–Ω –∏ –≤—Å—Ç–∞–≤–ª–µ–Ω)
                    </div>
                    <p class="converter-toggle" @click="showConverter = false">–í–≤–µ—Å—Ç–∏ ID –≤—Ä—É—á–Ω—É—é</p>
                </div>
                <div v-else>
                    <h1>–î–æ–±—Ä–æ –ø–æ–∂–∞–ª–æ–≤–∞—Ç—å!</h1>
                    <input type="text" v-model="telegramId" @keyup.enter="loadData" placeholder="–í–≤–µ–¥–∏—Ç–µ –≤–∞—à —á–∏—Å–ª–æ–≤–æ–π Telegram ID">
                    <button @click="loadData" :disabled="isLoading.boards">
                        <span v-if="!isLoading.boards">–ó–∞–≥—Ä—É–∑–∏—Ç—å –¥–∞–Ω–Ω—ã–µ</span>
                        <span v-else>–ó–∞–≥—Ä—É–∑–∫–∞...</span>
                    </button>
                    <p class="converter-toggle" @click="showConverter = true">–ù–µ –∑–Ω–∞–µ—Ç–µ —Å–≤–æ–π ID? –ü–æ–ª—É—á–∏—Ç—å –ø–æ Username</p>
                </div>
            </section>
            <section v-if="currentView !== 'login'">
                <div v-if="currentView === 'boards'">
                    <div v-if="isLoading.boards" class="loader-container"><div class="loader"></div></div>
                    <div v-else>
                        <div id="boards-list" v-if="boards.length > 0">
                            <button v-for="board in boards" :key="board.id" class="board-btn" @click="showItems(board)" :data-board-id="board.id" :data-board-name="`${board.emoji_icon || 'üìÅ'} ${board.name}`">
                                {{ board.emoji_icon || 'üìÅ' }} {{ board.name }}
                            </button>
                        </div>
                        <p v-else style="text-align: center;">–£ –≤–∞—Å –ø–æ–∫–∞ –Ω–µ—Ç –¥–æ—Å–æ–∫.</p>
                    </div>
                </div>
                <div v-if="currentView === 'items'">
                    <h2>{{ currentBoardName }}</h2>
                    <div v-if="isLoading.items" class="loader-container"><div class="loader"></div></div>
                    <div v-else>
                        <div id="items-grid" v-if="items.length > 0">
                            <div v-for="item in items" :key="item.id" class="item-card" @click="showItemInModal(item)" :data-item-id="item.id">
                                <p>{{ item.title }}</p>
                            </div>
                        </div>
                        <p v-else style="text-align: center;">–í —ç—Ç–æ–π –¥–æ—Å–∫–µ –ø–æ–∫–∞ –Ω–∏—á–µ–≥–æ –Ω–µ—Ç.</p>
                    </div>
                    <button @click="showBoards" class="back-btn">‚¨ÖÔ∏è –ù–∞–∑–∞–¥ –∫ —Å–ø–∏—Å–∫—É –¥–æ—Å–æ–∫</button>
                </div>
            </section>
        </main>
        
        <div v-if="modal.isOpen" class="modal-overlay" @click.self="closeModal">
            <div class="modal-content">
                <div v-if="isLoading.modal" class="loader-container"><div class="loader"></div></div>
                <div v-else>
                    <h2>{{ modal.title }}</h2>
                    <p v-if="modal.isError">{{ modal.contentUrl }}</p>
                    <a v-else :href="modal.contentUrl" target="_blank" rel="noopener noreferrer" class="open-link">–û—Ç–∫—Ä—ã—Ç—å</a>
                </div>
            </div>
        </div>
    </div>

    <script>
        const { createApp } = Vue;
        
        const app = createApp({
            data() {
                return {
                    apiBaseUrl: 'http://127.0.0.1:8000',
                    telegramId: '', currentView: 'login', boards: [], items: [], currentBoardName: '',
                    isLoading: { boards: false, items: false, modal: false, resolving: false },
                    modal: { isOpen: false, contentUrl: '', title: '', isError: false },
                    showConverter: false, usernameToResolve: '', resolvedId: ''
                }
            },
            methods: {
                async resolveUsername() {
                    let username = this.usernameToResolve.trim();
                    if (username.startsWith('@')) username = username.substring(1);
                    if (!username) return alert('–í–≤–µ–¥–∏—Ç–µ username.');
                    this.isLoading.resolving = true; this.resolvedId = '';
                    try {
                        const response = await fetch(`${this.apiBaseUrl}/resolve-username/${username}`);
                        if (!response.ok) throw new Error('–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å —Å —Ç–∞–∫–∏–º username –Ω–µ –Ω–∞–π–¥–µ–Ω.');
                        const data = await response.json();
                        this.resolvedId = data.telegram_id; this.telegramId = data.telegram_id; this.showConverter = false;
                    } catch (error) { alert(error.message); } 
                    finally { this.isLoading.resolving = false; }
                },
                async loadData() {
                    if (!this.telegramId || !/^\d+$/.test(this.telegramId)) return alert('–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –≤–≤–µ–¥–∏—Ç–µ –∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã–π —á–∏—Å–ª–æ–≤–æ–π Telegram ID.');
                    this.isLoading.boards = true;
                    try {
                        const response = await fetch(`${this.apiBaseUrl}/users/${this.telegramId}/boards/`);
                        if (!response.ok) throw new Error('–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –Ω–µ –Ω–∞–π–¥–µ–Ω. –ù–∞–ø–∏—à–∏—Ç–µ /start –≤–∞—à–µ–º—É –±–æ—Ç—É.');
                        this.boards = await response.json();
                        this.currentView = 'boards';
                    } catch (error) { alert(error.message); this.currentView = 'login'; }
                    finally { this.isLoading.boards = false; }
                },
                showBoards() { this.currentView = 'boards'; },
                async showItems(board) {
                    this.currentView = 'items';
                    this.currentBoardName = `${board.emoji_icon || 'üìÅ'} ${board.name}`;
                    this.isLoading.items = true; this.items = [];
                    try {
                        const response = await fetch(`${this.apiBaseUrl}/boards/${board.id}/items/`);
                        this.items = await response.json();
                    } catch (error) { alert('–ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å —ç–ª–µ–º–µ–Ω—Ç—ã.'); }
                    finally { this.isLoading.items = false; }
                },
                async showItemInModal(item) {
                    this.modal.isOpen = true;
                    this.isLoading.modal = true;
                    this.modal.title = item.title;
                    this.modal.isError = false;

                    try {
                        const response = await fetch(`${this.apiBaseUrl}/items/${item.id}/download_url`);
                        if (!response.ok) throw new Error('–ù–µ —É–¥–∞–ª–æ—Å—å –ø–æ–ª—É—á–∏—Ç—å —Å—Å—ã–ª–∫—É –Ω–∞ —Ñ–∞–π–ª.');
                        const data = await response.json();
                        this.modal.contentUrl = data.url;
                    } catch (error) {
                        this.modal.isError = true;
                        this.modal.contentUrl = '–ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å –∫–æ–Ω—Ç–µ–Ω—Ç. ' + error.message;
                    } finally {
                        this.isLoading.modal = false;
                    }
                },
                closeModal() {
                    this.modal.isOpen = false;
                    this.modal.contentUrl = '';
                    this.modal.title = '';
                }
            },
        });

        app.mount('#app');
    </script>
</body>
</html>